{"version":3,"sources":["../../src/react/YjsAboveEditable.tsx","../../src/lib/BaseYjsPlugin.ts","../../src/lib/withPlateYjs.ts","../../src/lib/withTCursors.ts","../../src/lib/withTYHistory.ts","../../src/lib/withTYjs.ts","../../src/react/YjsPlugin.tsx"],"sourcesContent":["import React from 'react';\n\nimport { YjsEditor } from '@slate-yjs/core';\nimport { useEditorPlugin, usePluginOption } from '@udecode/plate/react';\n\nimport { type YjsConfig, BaseYjsPlugin } from '../lib/BaseYjsPlugin';\n\nexport const YjsAboveEditable: React.FC<{\n  children: React.ReactNode;\n}> = ({ children }) => {\n  const { editor } = useEditorPlugin<YjsConfig>(BaseYjsPlugin);\n\n  const provider = usePluginOption(BaseYjsPlugin, 'provider');\n  const isSynced = usePluginOption(BaseYjsPlugin, 'isSynced');\n\n  React.useEffect(() => {\n    void provider.connect();\n\n    return () => provider.disconnect();\n  }, [provider]);\n\n  React.useEffect(() => {\n    YjsEditor.connect(editor as any);\n\n    return () => YjsEditor.disconnect(editor as any);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [provider.awareness, provider.document]);\n\n  if (!isSynced) return null;\n\n  return <>{children}</>;\n};\n","import type { HocuspocusProviderConfiguration } from '@hocuspocus/provider';\nimport type { WithCursorsOptions } from '@slate-yjs/core';\n\nimport { HocuspocusProvider } from '@hocuspocus/provider';\nimport { type PluginConfig, createTSlatePlugin } from '@udecode/plate';\n\nimport type { WithYjsOptions } from './withTYjs';\n\nimport { withPlateYjs } from './withPlateYjs';\n\nexport type YjsConfig = PluginConfig<\n  'yjs',\n  {\n    isConnected: boolean;\n    isSynced: boolean;\n    provider: HocuspocusProvider;\n    /** WithCursors options */\n    cursorOptions?: WithCursorsOptions;\n    disableCursors?: boolean;\n    /**\n     * HocuspocusProvider configuration\n     *\n     * @required\n     */\n    hocuspocusProviderOptions?: HocuspocusProviderConfiguration;\n    /** WithYjs options */\n    yjsOptions?: WithYjsOptions;\n  }\n>;\n\nexport const BaseYjsPlugin = createTSlatePlugin<YjsConfig>({\n  key: 'yjs',\n  extendEditor: withPlateYjs,\n  options: {\n    isConnected: false,\n    isSynced: false,\n    provider: {} as any,\n  },\n}).extend(({ getOptions, setOption }) => {\n  const { hocuspocusProviderOptions } = getOptions();\n\n  if (!hocuspocusProviderOptions) {\n    throw new Error('HocuspocusProvider configuration is required');\n  }\n\n  /**\n   * Create a new websocket-provider instance. As long as this provider, or the\n   * connected ydoc, is not destroyed, the changes will be synced to other\n   * clients via the connected server.\n   */\n  const provider = new HocuspocusProvider({\n    ...hocuspocusProviderOptions,\n    onAwarenessChange() {},\n    onConnect() {\n      setOption('isConnected', true);\n      hocuspocusProviderOptions.onConnect?.();\n    },\n    onDisconnect(data) {\n      setOption('isConnected', false);\n      setOption('isSynced', false);\n      hocuspocusProviderOptions.onDisconnect?.(data);\n    },\n    onSynced(data) {\n      setOption('isSynced', true);\n      hocuspocusProviderOptions.onSynced?.(data);\n    },\n  });\n\n  return {\n    options: { provider },\n  };\n});\n","import type { ExtendEditor, SlateEditor } from '@udecode/plate';\n\nimport * as Y from 'yjs';\n\nimport type { YjsConfig } from './BaseYjsPlugin';\n\nimport { type PlateYjsEditorProps, withTCursors } from './withTCursors';\nimport { withTYHistory } from './withTYHistory';\nimport { withTYjs } from './withTYjs';\n\nexport const withPlateYjs: ExtendEditor<YjsConfig> = ({\n  editor: e,\n  getOptions,\n}) => {\n  const editor = e as unknown as PlateYjsEditorProps & SlateEditor;\n\n  // not reactive\n  const { cursorOptions, disableCursors, provider, yjsOptions } = getOptions();\n\n  const sharedType = provider.document.get(\n    'content',\n    Y.XmlText\n  ) as any as Y.XmlText;\n\n  if (disableCursors) {\n    return withTYHistory(\n      withTYjs(editor, sharedType, {\n        autoConnect: false,\n        ...yjsOptions,\n      })\n    );\n  }\n\n  return withTYHistory(\n    withTCursors(\n      withTYjs(editor, sharedType, {\n        autoConnect: false,\n        ...yjsOptions,\n      }),\n      provider.awareness!,\n      cursorOptions\n    )\n  );\n};\n","import type { SlateEditor } from '@udecode/plate';\nimport type { Awareness } from 'y-protocols/awareness';\n\nimport {\n  type CursorEditor,\n  type WithCursorsOptions,\n  withCursors,\n} from '@slate-yjs/core';\n\nimport type { YjsEditorProps } from './withTYjs';\n\nexport type PlateYjsEditorProps = Pick<\n  CursorEditor,\n  | 'awareness'\n  | 'cursorDataField'\n  | 'selectionStateField'\n  | 'sendCursorData'\n  | 'sendCursorPosition'\n> &\n  YjsEditorProps;\n\nexport const withTCursors = <TCursorData extends Record<string, unknown>>(\n  editor: SlateEditor,\n  awareness: Awareness,\n  options?: WithCursorsOptions<TCursorData>\n) =>\n  withCursors(editor as any, awareness, options) as PlateYjsEditorProps &\n    SlateEditor &\n    YjsEditorProps;\n","import type { SlateEditor } from '@udecode/plate';\nimport type * as Y from 'yjs';\n\nimport {\n  type WithYHistoryOptions,\n  type YjsEditor,\n  withYHistory,\n} from '@slate-yjs/core';\n\nimport type { YjsEditorProps } from './withTYjs';\n\nexport type YHistoryEditor = {\n  undoManager: Y.UndoManager;\n  withoutSavingOrigin: unknown;\n  redo: () => void;\n  undo: () => void;\n} & YjsEditor;\n\nexport type YHistoryEditorProps = Pick<\n  YHistoryEditor,\n  'redo' | 'undo' | 'undoManager' | 'withoutSavingOrigin'\n> &\n  YjsEditorProps;\n\nexport const withTYHistory = (\n  editor: SlateEditor,\n  options?: WithYHistoryOptions\n) =>\n  withYHistory(editor as any, options) as SlateEditor &\n    YHistoryEditorProps &\n    YjsEditorProps;\n","import type { Operation, SlateEditor } from '@udecode/plate';\nimport type * as Y from 'yjs';\n\nimport { type YjsEditor, withYjs } from '@slate-yjs/core';\n\nexport type WithYjsOptions = {\n  autoConnect?: boolean;\n  // Origin used when applying local slate operations to yjs\n  localOrigin?: unknown;\n  // Origin used when storing positions\n  positionStorageOrigin?: unknown;\n};\n\nexport type YjsEditorProps = {\n  storeLocalChange: (op: Operation) => void;\n} & Pick<\n  YjsEditor,\n  | 'applyRemoteEvents'\n  | 'connect'\n  | 'disconnect'\n  | 'flushLocalChanges'\n  | 'isLocalOrigin'\n  | 'localOrigin'\n  | 'positionStorageOrigin'\n  | 'sharedRoot'\n>;\n\nexport const withTYjs = (\n  editor: SlateEditor,\n  sharedRoot: Y.XmlText,\n  options?: WithYjsOptions\n) =>\n  withYjs(editor as any, sharedRoot, options) as SlateEditor & YjsEditorProps;\n","import { toPlatePlugin } from '@udecode/plate/react';\n\nimport { BaseYjsPlugin } from '../lib/BaseYjsPlugin';\nimport { YjsAboveEditable } from './YjsAboveEditable';\n\n/** Enables support for real-time collaboration using Yjs. */\nexport const YjsPlugin = toPlatePlugin(BaseYjsPlugin, {\n  render: {\n    aboveEditable: YjsAboveEditable,\n  },\n});\n"],"mappings":";AAAA,OAAO,WAAW;AAElB,SAAS,iBAAiB;AAC1B,SAAS,iBAAiB,uBAAuB;;;ACAjD,SAAS,0BAA0B;AACnC,SAA4B,0BAA0B;;;ACFtD,YAAY,OAAO;;;ACCnB;AAAA,EAGE;AAAA,OACK;AAcA,IAAM,eAAe,CAC1B,QACA,WACA,YAEA,YAAY,QAAe,WAAW,OAAO;;;ACvB/C;AAAA,EAGE;AAAA,OACK;AAiBA,IAAM,gBAAgB,CAC3B,QACA,YAEA,aAAa,QAAe,OAAO;;;ACzBrC,SAAyB,eAAe;AAwBjC,IAAM,WAAW,CACtB,QACA,YACA,YAEA,QAAQ,QAAe,YAAY,OAAO;;;AHtBrC,IAAM,eAAwC,CAAC;AAAA,EACpD,QAAQ;AAAA,EACR;AACF,MAAM;AACJ,QAAM,SAAS;AAGf,QAAM,EAAE,eAAe,gBAAgB,UAAU,WAAW,IAAI,WAAW;AAE3E,QAAM,aAAa,SAAS,SAAS;AAAA,IACnC;AAAA,IACE;AAAA,EACJ;AAEA,MAAI,gBAAgB;AAClB,WAAO;AAAA,MACL,SAAS,QAAQ,YAAY;AAAA,QAC3B,aAAa;AAAA,QACb,GAAG;AAAA,MACL,CAAC;AAAA,IACH;AAAA,EACF;AAEA,SAAO;AAAA,IACL;AAAA,MACE,SAAS,QAAQ,YAAY;AAAA,QAC3B,aAAa;AAAA,QACb,GAAG;AAAA,MACL,CAAC;AAAA,MACD,SAAS;AAAA,MACT;AAAA,IACF;AAAA,EACF;AACF;;;ADbO,IAAM,gBAAgB,mBAA8B;AAAA,EACzD,KAAK;AAAA,EACL,cAAc;AAAA,EACd,SAAS;AAAA,IACP,aAAa;AAAA,IACb,UAAU;AAAA,IACV,UAAU,CAAC;AAAA,EACb;AACF,CAAC,EAAE,OAAO,CAAC,EAAE,YAAY,UAAU,MAAM;AACvC,QAAM,EAAE,0BAA0B,IAAI,WAAW;AAEjD,MAAI,CAAC,2BAA2B;AAC9B,UAAM,IAAI,MAAM,8CAA8C;AAAA,EAChE;AAOA,QAAM,WAAW,IAAI,mBAAmB;AAAA,IACtC,GAAG;AAAA,IACH,oBAAoB;AAAA,IAAC;AAAA,IACrB,YAAY;AACV,gBAAU,eAAe,IAAI;AAC7B,gCAA0B,YAAY;AAAA,IACxC;AAAA,IACA,aAAa,MAAM;AACjB,gBAAU,eAAe,KAAK;AAC9B,gBAAU,YAAY,KAAK;AAC3B,gCAA0B,eAAe,IAAI;AAAA,IAC/C;AAAA,IACA,SAAS,MAAM;AACb,gBAAU,YAAY,IAAI;AAC1B,gCAA0B,WAAW,IAAI;AAAA,IAC3C;AAAA,EACF,CAAC;AAED,SAAO;AAAA,IACL,SAAS,EAAE,SAAS;AAAA,EACtB;AACF,CAAC;;;ADhEM,IAAM,mBAER,CAAC,EAAE,SAAS,MAAM;AACrB,QAAM,EAAE,OAAO,IAAI,gBAA2B,aAAa;AAE3D,QAAM,WAAW,gBAAgB,eAAe,UAAU;AAC1D,QAAM,WAAW,gBAAgB,eAAe,UAAU;AAE1D,QAAM,UAAU,MAAM;AACpB,SAAK,SAAS,QAAQ;AAEtB,WAAO,MAAM,SAAS,WAAW;AAAA,EACnC,GAAG,CAAC,QAAQ,CAAC;AAEb,QAAM,UAAU,MAAM;AACpB,cAAU,QAAQ,MAAa;AAE/B,WAAO,MAAM,UAAU,WAAW,MAAa;AAAA,EAEjD,GAAG,CAAC,SAAS,WAAW,SAAS,QAAQ,CAAC;AAE1C,MAAI,CAAC,SAAU,QAAO;AAEtB,SAAO,0DAAG,QAAS;AACrB;;;AM/BA,SAAS,qBAAqB;AAMvB,IAAM,YAAY,cAAc,eAAe;AAAA,EACpD,QAAQ;AAAA,IACN,eAAe;AAAA,EACjB;AACF,CAAC;","names":[]}